<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .hidden { display: none; }
        #login { text-align: center; margin-top: 50px; }
        #app { max-width: 800px; margin: 0 auto; }
        #userInfo {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        #userInfo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .zone {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
        }
        .task {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .task input[type="checkbox"] { margin-right: 10px; }
        .task .chip {
            background: #e0e0e0;
            padding: 2px 6px;
            margin-left: 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .form { margin: 10px 0; }
        .form input, .form select {
            margin: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #leaderboardTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background: #f2f2f2; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        @media (max-width: 600px) {
            #app { padding: 10px; }
            .zone { padding: 10px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login">
        <h1>Todo List Game</h1>
        <button id="signInBtn">Đăng Nhập Với Google</button>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <div id="userInfo"></div>
        <button onclick="showAddZoneForm()">Tạo Zone Mới</button>
        <button onclick="closeDay()">Kết Thúc Ngày</button>
        <button onclick="showLeaderboard()">Bảng Xếp Hạng</button>
        <button onclick="signOut()">Đăng Xuất</button>
        <div id="addZoneForm" class="hidden form">
            <input type="text" id="zoneName" placeholder="Tên Zone">
            <input type="number" id="pointPerTask" placeholder="Điểm mỗi task" value="10">
            <input type="number" id="bonusCompleteAll" placeholder="Bonus hoàn thành hết" value="50">
            <input type="number" id="penaltyNotComplete" placeholder="Penalty không hoàn thành" value="20">
            <button onclick="addZone()">Thêm Zone</button>
        </div>
        <div id="zones"></div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="hidden">
        <h1>Bảng Xếp Hạng</h1>
        <table id="leaderboardTable">
            <tr><th>Icon</th><th>Tên</th><th>Điểm</th></tr>
        </table>
        <button onclick="backToApp()">Quay Lại</button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

    <script type="module">
        // Import Firebase modular APIs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, query, orderBy, limit, runTransaction, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAEcuO05o6LGiWvVF6c8k1yUj8l_a4VqUc",
            authDomain: "hello-f5c5a.firebaseapp.com",
            projectId: "hello-f5c5a",
            storageBucket: "hello-f5c5a.firebasestorage.app",
            messagingSenderId: "766606826615",
            appId: "1:766606826615:web:783077344649c7f8113a72",
            measurementId: "G-W0SCHMJPW5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        db.enablePersistence().catch(err => console.error('Persistence failed:', err));

        // Auth State Listener
        let currentUser = null;
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initUserData(user);
                renderUserInfo();
                renderZones();
            } else {
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('leaderboard').classList.add('hidden');
                document.getElementById('login').classList.remove('hidden');
            }
        });

        // Sign In with Google
        document.getElementById('signInBtn').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showToast('Đăng nhập thành công!');
            } catch (error) {
                console.error('Sign-in error:', error);
                showToast('Lỗi đăng nhập: ' + error.message);
            }
        });

        // Sign Out
        async function signOutUser() {
            try {
                await signOut(auth);
                showToast('Đã đăng xuất');
            } catch (error) {
                console.error('Sign-out error:', error);
                showToast('Lỗi đăng xuất: ' + error.message);
            }
        }

        // Initialize User Data in Firestore
        async function initUserData(user) {
            const userRef = doc(db, 'users', user.uid);
            try {
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    await setDoc(userRef, {
                        displayName: user.displayName || 'Người chơi',
                        photoURL: user.photoURL || 'https://via.placeholder.com/40',
                        email: user.email,
                        score: 0,
                        dailyClosedKey: '',
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    await setDoc(doc(db, 'leaderboard', user.uid), {
                        uid: user.uid,
                        displayName: user.displayName || 'Người chơi',
                        photoURL: user.photoURL || 'https://via.placeholder.com/40',
                        score: 0,
                        updatedAt: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Init user data error:', error);
                showToast('Lỗi khởi tạo dữ liệu: ' + error.message);
            }
        }

        // Render User Info
        function renderUserInfo() {
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <img src="${currentUser.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar">
                <span>${currentUser.displayName} - Điểm: <span id="userScore">0</span></span>
            `;
            onSnapshot(doc(db, 'users', currentUser.uid), doc => {
                if (doc.exists()) {
                    document.getElementById('userScore').textContent = doc.data().score || 0;
                }
            });
        }

        // Show Toast Notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // Show Add Zone Form
        function showAddZoneForm() {
            document.getElementById('addZoneForm').classList.toggle('hidden');
        }

        // Add Zone
        async function addZone() {
            const name = document.getElementById('zoneName').value.trim();
            const pointPerTask = parseInt(document.getElementById('pointPerTask').value) || 10;
            const bonusCompleteAll = parseInt(document.getElementById('bonusCompleteAll').value) || 50;
            const penaltyNotComplete = parseInt(document.getElementById('penaltyNotComplete').value) || 20;
            if (!name) return showToast('Vui lòng nhập tên Zone!');
            try {
                await addDoc(collection(db, `users/${currentUser.uid}/zones`), {
                    name,
                    pointPerTask,
                    bonusCompleteAll,
                    penaltyNotComplete,
                    repeatPolicy: 'inherit',
                    createdAt: serverTimestamp()
                });
                showToast('Thêm Zone thành công!');
                document.getElementById('addZoneForm').classList.add('hidden');
                document.getElementById('zoneName').value = '';
            } catch (error) {
                console.error('Add zone error:', error);
                showToast('Lỗi thêm Zone: ' + error.message);
            }
        }

        // Render Zones
        function renderZones() {
            const zonesDiv = document.getElementById('zones');
            zonesDiv.innerHTML = '';
            onSnapshot(collection(db, `users/${currentUser.uid}/zones`), snapshot => {
                zonesDiv.innerHTML = snapshot.empty ? '<p>Chưa có Zone nào</p>' : '';
                snapshot.forEach(doc => {
                    const zone = { id: doc.id, ...doc.data() };
                    const zoneDiv = document.createElement('div');
                    zoneDiv.className = 'zone';
                    zoneDiv.innerHTML = `
                        <h3>${zone.name} (Điểm/task: ${zone.pointPerTask}, Bonus: ${zone.bonusCompleteAll}, Penalty: ${zone.penaltyNotComplete})</h3>
                        <button onclick="showAddTaskForm('${zone.id}')">Thêm Task</button>
                        <div id="addTaskForm_${zone.id}" class="hidden form">
                            <input type="text" id="taskDesc_${zone.id}" placeholder="Mô tả task">
                            <select id="repeatType_${zone.id}">
                                <option value="none">Không lặp</option>
                                <option value="daily">Mỗi ngày</option>
                                <option value="weekly">Theo tuần</option>
                            </select>
                            <div id="weeklyDays_${zone.id}" class="hidden">
                                <label><input type="checkbox" value="1"> T2</label>
                                <label><input type="checkbox" value="2"> T3</label>
                                <label><input type="checkbox" value="3"> T4</label>
                                <label><input type="checkbox" value="4"> T5</label>
                                <label><input type="checkbox" value="5"> T6</label>
                                <label><input type="checkbox" value="6"> T7</label>
                                <label><input type="checkbox" value="0"> CN</label>
                            </div>
                            <button onclick="addTask('${zone.id}')">Thêm Task</button>
                        </div>
                        <div id="tasks_${zone.id}"></div>
                    `;
                    zonesDiv.appendChild(zoneDiv);
                    renderTasks(zone.id);
                    document.getElementById(`repeatType_${zone.id}`).addEventListener('change', e => {
                        document.getElementById(`weeklyDays_${zone.id}`).classList.toggle('hidden', e.target.value !== 'weekly');
                    });
                });
            });
        }

        // Show Add Task Form
        function showAddTaskForm(zoneId) {
            document.getElementById(`addTaskForm_${zoneId}`).classList.toggle('hidden');
        }

        // Add Task
        async function addTask(zoneId) {
            const desc = document.getElementById(`taskDesc_${zoneId}`).value.trim();
            const repeatType = document.getElementById(`repeatType_${zoneId}`).value;
            const weeklyDays = repeatType === 'weekly' ? Array.from(document.querySelectorAll(`#weeklyDays_${zoneId} input:checked`)).map(cb => parseInt(cb.value)) : [];
            if (!desc) return showToast('Vui lòng nhập mô tả task!');
            try {
                const dayKey = getDayKey();
                await addDoc(collection(db, `users/${currentUser.uid}/zones/${zoneId}/tasks`), {
                    text: desc,
                    completed: false,
                    repeatType,
                    weeklyDays,
                    lastResetKey: dayKey,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                showToast('Thêm Task thành công!');
                document.getElementById(`addTaskForm_${zoneId}`).classList.add('hidden');
                document.getElementById(`taskDesc_${zoneId}`).value = '';
            } catch (error) {
                console.error('Add task error:', error);
                showToast('Lỗi thêm Task: ' + error.message);
            }
        }

        // Render Tasks
        function renderTasks(zoneId) {
            const tasksDiv = document.getElementById(`tasks_${zoneId}`);
            tasksDiv.innerHTML = '';
            onSnapshot(collection(db, `users/${currentUser.uid}/zones/${zoneId}/tasks`), async snapshot => {
                tasksDiv.innerHTML = snapshot.empty ? '<p>Chưa có Task nào</p>' : '';
                const zoneRef = doc(db, `users/${currentUser.uid}/zones/${zoneId}`);
                const zoneDoc = await getDoc(zoneRef);
                const zone = zoneDoc.data();
                const dayKey = getDayKey();
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    const task = { id: doc.id, ...doc.data() };
                    // Auto-reset tasks if needed
                    let shouldReset = false;
                    if (task.repeatType === 'daily' && task.lastResetKey !== dayKey) {
                        shouldReset = true;
                    } else if (task.repeatType === 'weekly' && task.lastResetKey !== dayKey && task.weeklyDays.includes(new Date().getDay())) {
                        shouldReset = true;
                    }
                    if (shouldReset) {
                        batch.update(doc.ref, { completed: false, lastResetKey: dayKey, updatedAt: serverTimestamp() });
                    }
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'task';
                    const repeatInfo = task.repeatType === 'none' ? '' : ` <span class="chip">${task.repeatType}${task.repeatType === 'weekly' ? ' - ' + task.weeklyDays.map(d => ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'][d]).join(',') : ''}</span>`;
                    taskDiv.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="completeTask('${zoneId}', '${task.id}', this.checked)">
                        ${task.text}${repeatInfo}
                    `;
                    tasksDiv.appendChild(taskDiv);
                });
                if (batch._mutations.length > 0) await batch.commit();
            });
        }

        // Complete Task
        async function completeTask(zoneId, taskId, checked) {
            try {
                await runTransaction(db, async transaction => {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const zoneRef = doc(db, `users/${currentUser.uid}/zones/${zoneId}`);
                    const taskRef = doc(db, `users/${currentUser.uid}/zones/${zoneId}/tasks/${taskId}`);
                    const userDoc = await transaction.get(userRef);
                    const zoneDoc = await transaction.get(zoneRef);
                    const tasksSnap = await getDocs(collection(db, `users/${currentUser.uid}/zones/${zoneId}/tasks`));
                    if (!userDoc.exists() || !zoneDoc.exists()) throw new Error('Dữ liệu không tồn tại');
                    let score = userDoc.data().score || 0;
                    const zone = zoneDoc.data();
                    if (checked) {
                        score += zone.pointPerTask;
                        const allCompleted = tasksSnap.docs.every(t => t.id === taskId ? checked : t.data().completed);
                        if (allCompleted && tasksSnap.size > 0) {
                            const dayKey = getDayKey();
                            if (zoneDoc.data().zoneDailyBonusKey !== dayKey) {
                                score += zone.bonusCompleteAll;
                                transaction.update(zoneRef, { zoneDailyBonusKey: dayKey, updatedAt: serverTimestamp() });
                                showToast(`Bonus +${zone.bonusCompleteAll} điểm cho Zone ${zone.name}`);
                            }
                        }
                    } else {
                        score -= zone.pointPerTask;
                    }
                    transaction.update(userRef, { score, updatedAt: serverTimestamp() });
                    transaction.update(doc(db, 'leaderboard', currentUser.uid), { score, updatedAt: serverTimestamp() });
                    transaction.update(taskRef, { completed: checked, updatedAt: serverTimestamp() });
                });
                showToast('Cập nhật task thành công!');
            } catch (error) {
                console.error('Complete task error:', error);
                showToast('Lỗi cập nhật task: ' + error.message);
            }
        }

        // Close Day
        async function closeDay() {
            const dayKey = getDayKey();
            try {
                await runTransaction(db, async transaction => {
                    const userRef = doc(db, 'users', currentUser.uid);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw new Error('User không tồn tại');
                    if (userDoc.data().dailyClosedKey === dayKey) throw new Error('Hôm nay đã đóng!');
                    let score = userDoc.data().score || 0;
                    const zonesSnap = await getDocs(collection(db, `users/${currentUser.uid}/zones`));
                    const batch = writeBatch(db);
                    let deltaScore = 0;
                    for (const zoneDoc of zonesSnap.docs) {
                        const zone = zoneDoc.data();
                        const tasksSnap = await getDocs(collection(db, `users/${currentUser.uid}/zones/${zoneDoc.id}/tasks`));
                        if (tasksSnap.size > 0 && !tasksSnap.docs.every(t => t.data().completed)) {
                            deltaScore -= zone.penaltyNotComplete;
                            showToast(`Penalty -${zone.penaltyNotComplete} điểm cho Zone ${zone.name}`);
                        }
                    }
                    score += deltaScore;
                    transaction.update(userRef, { score, dailyClosedKey: dayKey, updatedAt: serverTimestamp() });
                    transaction.update(doc(db, 'leaderboard', currentUser.uid), { score, updatedAt: serverTimestamp() });
                    await setDoc(doc(db, `audit/${dayKey}/closes`, currentUser.uid), {
                        uid: currentUser.uid,
                        dateKey: dayKey,
                        closedAt: serverTimestamp(),
                        deltaScore
                    });
                    for (const zoneDoc of zonesSnap.docs) {
                        const tasksSnap = await getDocs(collection(db, `users/${currentUser.uid}/zones/${zoneDoc.id}/tasks`));
                        tasksSnap.forEach(taskDoc => {
                            const task = taskDoc.data();
                            let shouldReset = false;
                            if (task.repeatType === 'daily' && task.lastResetKey !== dayKey) {
                                shouldReset = true;
                            } else if (task.repeatType === 'weekly' && task.lastResetKey !== dayKey && task.weeklyDays.includes(new Date().getDay())) {
                                shouldReset = true;
                            }
                            if (shouldReset) {
                                batch.update(taskDoc.ref, { completed: false, lastResetKey: dayKey, updatedAt: serverTimestamp() });
                            }
                        });
                    }
                    if (batch._mutations.length > 0) await batch.commit();
                });
                showToast('Đã kết thúc ngày!');
            } catch (error) {
                console.error('Close day error:', error);
                showToast('Lỗi kết thúc ngày: ' + error.message);
            }
        }

        // Get Day Key (UTC+7)
        function getDayKey() {
            const date = new Date();
            const offset = 7 * 60; // UTC+7
            const localTime = date.getTime() + (date.getTimezoneOffset() * 60000) + (offset * 60000);
            const localDate = new Date(localTime);
            return localDate.toISOString().split('T')[0]; // YYYY-MM-DD
        }

        // Show Leaderboard
        function showLeaderboard() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('leaderboard').classList.remove('hidden');
            renderLeaderboard();
        }

        // Render Leaderboard
        function renderLeaderboard() {
            const table = document.getElementById('leaderboardTable');
            table.innerHTML = '<tr><th>Icon</th><th>Tên</th><th>Điểm</th></tr>';
            onSnapshot(query(collection(db, 'leaderboard'), orderBy('score', 'desc'), limit(10)), snapshot => {
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${user.photoURL}" width="30" height="30" style="border-radius: 50%;"></td>
                        <td>${user.displayName}</td>
                        <td>${user.score}</td>
                    `;
                    table.appendChild(row);
                });
            }, error => {
                console.error('Leaderboard error:', error);
                showToast('Lỗi tải leaderboard: ' + error.message);
            });
        }

        function backToApp() {
            document.getElementById('leaderboard').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }
    </script>
</body>
</html>
