<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .hidden { display: none; }
        #login { text-align: center; margin-top: 50px; }
        #app { max-width: 800px; margin: 0 auto; }
        #userInfo {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        #userInfo img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .zone {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 5px;
        }
        .task {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .task input[type="checkbox"] { margin-right: 10px; }
        .task .chip {
            background: #e0e0e0;
            padding: 2px 6px;
            margin-left: 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .form { margin: 10px 0; }
        .form input, .form select {
            margin: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #leaderboardTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background: #f2f2f2; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        @media (max-width: 600px) {
            #app { padding: 10px; }
            .zone { padding: 10px; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login">
        <h1>Todo List Game</h1>
        <button id="signInBtn">Đăng Nhập Với Google</button>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <div id="userInfo"></div>
        <button onclick="showAddZoneForm()">Tạo Zone Mới</button>
        <button onclick="closeDay()">Kết Thúc Ngày</button>
        <button onclick="showLeaderboard()">Bảng Xếp Hạng</button>
        <button onclick="signOut()">Đăng Xuất</button>
        <div id="addZoneForm" class="hidden form">
            <input type="text" id="zoneName" placeholder="Tên Zone">
            <input type="number" id="pointPerTask" placeholder="Điểm mỗi task" value="10">
            <input type="number" id="bonusCompleteAll" placeholder="Bonus hoàn thành hết" value="50">
            <input type="number" id="penaltyNotComplete" placeholder="Penalty không hoàn thành" value="20">
            <button onclick="addZone()">Thêm Zone</button>
        </div>
        <div id="zones"></div>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="hidden">
        <h1>Bảng Xếp Hạng</h1>
        <table id="leaderboardTable">
            <tr><th>Icon</th><th>Tên</th><th>Điểm</th></tr>
        </table>
        <button onclick="backToApp()">Quay Lại</button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

    <script>
        // TODO: Thay bằng Firebase config của bạn từ Firebase Console
        const firebaseConfig = {
          apiKey: "AIzaSyAEcuO05o6LGiWvVF6c8k1yUj8l_a4VqUc",
          authDomain: "hello-f5c5a.firebaseapp.com",
          projectId: "hello-f5c5a",
          storageBucket: "hello-f5c5a.firebasestorage.app",
          messagingSenderId: "766606826615",
          appId: "1:766606826615:web:783077344649c7f8113a72",
          measurementId: "G-W0SCHMJPW5"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(err => console.error('Persistence failed:', err));

        // Auth State Listener
        let currentUser = null;
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                initUserData(user);
                renderUserInfo();
                renderZones();
            } else {
                currentUser = null;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('leaderboard').classList.add('hidden');
                document.getElementById('login').classList.remove('hidden');
            }
        });

        // Sign In with Google
        document.getElementById('signInBtn').addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                showToast('Lỗi đăng nhập: ' + error.message);
            }
        });

        // Sign Out
        function signOut() {
            auth.signOut().catch(err => showToast('Lỗi đăng xuất: ' + err.message));
        }

        // Initialize User Data in Firestore
        async function initUserData(user) {
            const userRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userRef.get();
                if (!doc.exists) {
                    await userRef.set({
                        displayName: user.displayName || 'Người chơi',
                        photoURL: user.photoURL || 'https://via.placeholder.com/40',
                        email: user.email,
                        score: 0,
                        dailyClosedKey: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Initialize leaderboard entry
                    await db.collection('leaderboard').doc(user.uid).set({
                        uid: user.uid,
                        displayName: user.displayName || 'Người chơi',
                        photoURL: user.photoURL || 'https://via.placeholder.com/40',
                        score: 0,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                showToast('Lỗi khởi tạo dữ liệu: ' + error.message);
            }
        }

        // Render User Info
        function renderUserInfo() {
            const userInfo = document.getElementById('userInfo');
            userInfo.innerHTML = `
                <img src="${currentUser.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar">
                <span>${currentUser.displayName} - Điểm: <span id="userScore">0</span></span>
            `;
            // Fetch and update score
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (doc.exists) {
                    document.getElementById('userScore').textContent = doc.data().score || 0;
                }
            });
        }

        // Show Toast Notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // Show Add Zone Form
        function showAddZoneForm() {
            document.getElementById('addZoneForm').classList.toggle('hidden');
        }

        // TODO: Implement addZone()
        async function addZone() {
            // Lấy input từ form, lưu vào Firestore (users/{uid}/zones)
            // Cập nhật UI bằng renderZones()
            showToast('Chức năng thêm Zone chưa được triển khai');
        }

        // TODO: Implement renderZones()
        function renderZones() {
            const zonesDiv = document.getElementById('zones');
            zonesDiv.innerHTML = '<p>Chưa có Zone nào</p>';
            // Lắng nghe Firestore snapshot (users/{uid}/zones)
            // Render danh sách zones, mỗi zone có form thêm task
        }

        // TODO: Implement addTask(zoneId)
        async function addTask(zoneId) {
            // Lưu task vào Firestore (users/{uid}/zones/{zoneId}/tasks)
            // Cập nhật UI
        }

        // TODO: Implement completeTask(zoneId, taskId)
        async function completeTask(zoneId, taskId, checked) {
            // Transaction: Cập nhật task.completed, tăng/giảm score
            // Check bonusCompleteAll nếu cần
        }

        // TODO: Implement closeDay()
        async function closeDay() {
            // Transaction: Tính penalty/bonus per zone, update score
            // Reset tasks lặp (daily/weekly) dựa trên dayKey (YYYY-MM-DD, UTC+7)
            // Ghi log vào audit/{dateKey}/closes/{uid}
        }

        // TODO: Implement showLeaderboard() and renderLeaderboard()
        function showLeaderboard() {
            document.getElementById('app').classList.add('hidden');
            document.getElementById('leaderboard').classList.remove('hidden');
            renderLeaderboard();
        }

        function renderLeaderboard() {
            const table = document.getElementById('leaderboardTable');
            table.innerHTML = '<tr><th>Icon</th><th>Tên</th><th>Điểm</th></tr>';
            // Query Firestore leaderboard/*, orderBy score desc, limit 10
            showToast('Chức năng leaderboard chưa được triển khai');
        }

        function backToApp() {
            document.getElementById('leaderboard').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }
    </script>
</body>
</html>
